<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="zh">
  <head>
    <title>"使用RIDC在webcenter portal集成ECM的文档查询功能" - 邓德昭的技术博客</title>
    <link href="http://fonts.googleapis.com/css?family=Arimo:400,700|Inika" rel="stylesheet" type="text/css" />
    <link rel="stylesheet" type="text/css" href="http://pelican.dengdezhao.cn/theme/bootstrap.css" />
    <link rel="stylesheet" type="text/css" href="http://pelican.dengdezhao.cn/theme/pastie.css" />
    <link href="http://pelican.dengdezhao.cn/" type="application/atom+xml" rel="alternate" title="邓德昭的技术博客 Atom Feed" />


  </head>

  <body>
    <div class="container">
      <div class="row">
        <div class="span8">
<div id="content">
    <div class="header">
        <h1>"使用RIDC在webcenter portal集成ECM的文档查询功能"</h1>
    </div>
    <p class="meta"><small><span><a href="http://pelican.dengdezhao.cn/author/pierreorz/">pierreorz</a> - </span><span>Fri 28 November 2014</span> - <span class="tags"><a href="/tag/ECM/">ECM</a></span></small></p>
        <div class="entry-content">
        <h4><i class="icon-file"></i>   需求：</h4>
<p>标准的document service很不灵活，实际开发中少不了要开发定制。那么问题来了，通过RIDC很灵活的查询出了需要的文档，如何集成到portal上去呢</p>
<h4><i class="icon-folder-open"></i> 分析：</h4>
<p>使用RIDC查询出需要的文档，存放在POJO等数据模型中
利用POJO生成dataControl，开发taskflow等UI层
将以上功能开发成为extend.spaces.webapp，扩展到webcenter spaces
以下主要展现第一步：通过RIDC查询及POJO生成数据模型。</p>
<h4><i class="icon-pencil"></i> 技术实现：</h4>
<ul>
<li>使用RIDC查询文档</li>
</ul>
<p>以下是主要查询方法, query传入的即是ECM的queryText，例如：
{% codeblock lang:java %}
dDocType <matches> <code>PJT-INTERFACE-DOC</code>
{% endcodeblock %}
通过拼接好需要的查询条件以及用户便可以查询出文档。
{% codeblock lang:java %}
        public List<Document> search(String username, String query) {
        ServiceResponse serviceResponse = null;
        List<Document> list = new ArrayList<Document>();</p>
<div class="highlight"><pre><span></span>    <span class="nt">try</span> <span class="p">{</span>
        <span class="n">if</span> <span class="p">(</span><span class="n">query</span> <span class="o">==</span> <span class="n">null</span><span class="p">)</span> <span class="err">{</span>
            <span class="n">return</span> <span class="n">list</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="nt">IdcClient</span> <span class="nt">client</span> <span class="o">=</span> <span class="nt">getIdcClient</span><span class="o">();</span>
        <span class="nt">DataBinder</span> <span class="nt">dataBinderReq</span> <span class="o">=</span> <span class="nt">client</span><span class="nc">.createBinder</span><span class="o">();</span>
        <span class="nt">dataBinderReq</span><span class="nc">.putLocal</span><span class="o">(</span><span class="s2">&quot;IdcService&quot;</span><span class="o">,</span> <span class="s2">&quot;GET_SEARCH_RESULTS&quot;</span><span class="o">);</span>
        <span class="nt">dataBinderReq</span><span class="nc">.putLocal</span><span class="o">(</span><span class="s2">&quot;QueryText&quot;</span><span class="o">,</span> <span class="nt">query</span><span class="nc">.toString</span><span class="o">());</span>
        <span class="nt">dataBinderReq</span><span class="nc">.putLocal</span><span class="o">(</span><span class="s2">&quot;ResultCount&quot;</span><span class="o">,</span> <span class="s2">&quot;100&quot;</span><span class="o">);</span>
        <span class="nt">serviceResponse</span> <span class="o">=</span>
                <span class="nt">client</span><span class="nc">.sendRequest</span><span class="o">(</span><span class="nt">new</span> <span class="nt">IdcContext</span><span class="o">(</span><span class="nt">username</span><span class="o">),</span> <span class="nt">dataBinderReq</span><span class="o">);</span>
        <span class="nt">DataBinder</span> <span class="nt">dataBinderRes</span> <span class="o">=</span> <span class="nt">serviceResponse</span><span class="nc">.getResponseAsBinder</span><span class="o">();</span>
        <span class="nt">DataResultSet</span> <span class="nt">resultSet</span> <span class="o">=</span>
            <span class="nt">dataBinderRes</span><span class="nc">.getResultSet</span><span class="o">(</span><span class="s2">&quot;SearchResults&quot;</span><span class="o">);</span>
        <span class="nt">for</span> <span class="o">(</span><span class="nt">DataObject</span> <span class="nt">dataObject</span> <span class="o">:</span> <span class="nt">resultSet</span><span class="nc">.getRows</span><span class="o">())</span> <span class="p">{</span>
            <span class="n">Document</span> <span class="n">d</span> <span class="o">=</span> <span class="n">new</span> <span class="n">Document</span><span class="p">();</span>
            <span class="n">d</span><span class="o">.</span><span class="n">setContentId</span><span class="p">(</span><span class="n">dataObject</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;dDocName&quot;</span><span class="p">));</span>
            <span class="n">d</span><span class="o">.</span><span class="n">setDocumentId</span><span class="p">(</span><span class="n">dataObject</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;dID&quot;</span><span class="p">));</span>
            <span class="n">d</span><span class="o">.</span><span class="n">setOwner</span><span class="p">(</span><span class="n">dataObject</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;dDocAuthor&quot;</span><span class="p">));</span>
            <span class="n">d</span><span class="o">.</span><span class="n">setTitle</span><span class="p">(</span><span class="n">dataObject</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;dDocTitle&quot;</span><span class="p">));</span>
            <span class="n">d</span><span class="o">.</span><span class="n">setDocType</span><span class="p">(</span><span class="n">dataObject</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;dDocType&quot;</span><span class="p">));</span>
            <span class="n">d</span><span class="o">.</span><span class="n">setXspeciality</span><span class="p">(</span><span class="n">dataObject</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;xSPECIALTY&quot;</span><span class="p">));</span>
            <span class="n">d</span><span class="o">.</span><span class="n">setXrcvMajor</span><span class="p">(</span><span class="n">dataObject</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;xRCV_MAJOR&quot;</span><span class="p">));</span>
            <span class="n">Date</span> <span class="n">date</span> <span class="o">=</span> <span class="n">dataObject</span><span class="o">.</span><span class="n">getDate</span><span class="p">(</span><span class="s2">&quot;dInDate&quot;</span><span class="p">);</span>
            <span class="n">SimpleDateFormat</span> <span class="n">sf</span> <span class="o">=</span> <span class="n">new</span> <span class="n">SimpleDateFormat</span><span class="p">(</span><span class="s2">&quot;yyyy/mm/dd&quot;</span><span class="p">);</span>
            <span class="n">String</span> <span class="n">format</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">date</span><span class="p">);</span>
            <span class="n">d</span><span class="o">.</span><span class="n">setDindate</span><span class="p">(</span><span class="n">format</span><span class="p">);</span>
            <span class="n">list</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="err">}</span> <span class="nt">catch</span> <span class="o">(</span><span class="nt">Exception</span> <span class="nt">ex</span><span class="o">)</span> <span class="p">{</span>
        <span class="n">System</span><span class="o">.</span><span class="n">out</span><span class="o">.</span><span class="n">println</span><span class="p">(</span><span class="s2">&quot;Error Search: &quot;</span> <span class="o">+</span> <span class="n">ex</span><span class="o">.</span><span class="n">getMessage</span><span class="p">());</span>
    <span class="p">}</span> <span class="nt">finally</span> <span class="p">{</span>
        <span class="n">if</span> <span class="p">(</span><span class="n">serviceResponse</span> <span class="o">!=</span> <span class="n">null</span><span class="p">)</span> <span class="err">{</span>
            <span class="n">serviceResponse</span><span class="o">.</span><span class="n">close</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="err">}</span>
    <span class="nt">return</span> <span class="nt">list</span><span class="o">;</span>
<span class="err">}</span> <span class="o">//</span>
</pre></div>


<p _="%" endcodeblock="endcodeblock">{% endcodeblock %}
其中Document.java即是POJO类
{% codeblock lang:java %}
public class Document {
    private String contentId;
    private String documentId;
    private String owner;
    private String title;
    private String doctype;
    private String securitygroup;
    private String dindate;
    private String xDesignPhase;
    private String xspeciality;//send
    private String xrcvMajor;//receive
       ......get set accessor......
}//end class</p>
<p>创建facade类：MyCondition.java，主要是调用search方法接受RIDC查询的结果集，生成dataControl供UI层使用。参考代码如下：
{% codeblock lang:java %}
public class MyCondition {
    private static final ADFLogger LOGGER = ADFLogger.createADFLogger(MyCondition.class);
    private ArrayList<Document> receiveDocumentList;
    private ArrayList<Document> sendDocumentList;
    public MyCondition() {
        this.receiveDocumentList=new ArrayList<Document>();
        this.sendDocumentList=new ArrayList<Document>();
    }
    /<strong><em>*</em></strong>
     * 初始化，调用RIDC API查询出文档数据集
     * <strong><em>*</em>/
    public String init(){
        LOGGER.severe("start init....");
        Object userId = JSFUtils.resolveExpression("#{securityContext.userName}");
        Object projectCode = JSFUtils.resolveExpression("#{pageFlowScope.inputProjectCode}");
        List<String> spcCode = (List<String>)(JSFUtils.resolveExpression("#{pageFlowScope.spcCode}")==null?null:JSFUtils.resolveExpression("#{pageFlowScope.spcCode}"));
        if(userId==null||"".equals(userId)){
            LOGGER.severe("userId is null ");
            FacesMessage msg = new FacesMessage("用户为空请重试!");
            JSFUtils.getFacesContext().addMessage(null, msg);
            return "NO";
        }
        if(projectCode==null||"".equals(projectCode)){
            LOGGER.severe("projectCode is null ");
            FacesMessage msg = new FacesMessage("项目ID为空请重试!");
            JSFUtils.getFacesContext().addMessage(null, msg);
            return "NO";
        }
        /</strong><strong><em>*
         * 
         * 生成发出专业SQL,生成接受专业SQL
         * 
         * </em></strong><em>/
        String sendSql=" xSPECIALTY <matches> <code>NULL</code> ";
        String receiveSql=" xRCV_MAJOR <matches> <code>NULL</code> ";
        if(spcCode==null||spcCode.size()==0){
            LOGGER.severe("spcCode is null or size is 0");
            return "NO";
        }
        for(int i=0;i<spcCode.size();i++){
            sendSql=sendSql+" <OR> "+"xSPECIALTY <matches> <code>"+spcCode.get(i)+"</code> ";
            receiveSql=receiveSql+" <OR> "+"xRCV_MAJOR <matches> <code>"+spcCode.get(i)+"</code> ";
        }
        sendSql="("+sendSql+") <AND> dDocType <matches> <code>PJT-INTERFACE-DOC</code> <AND> xPROJECT_NUM <starts> <code>"+projectCode+"</code>";
        receiveSql="("+receiveSql+") <AND> dDocType <matches> <code>PJT-INTERFACE-DOC</code> <AND> xPROJECT_NUM <starts> <code>"+projectCode+"</code>";
        LOGGER.severe("sendSql:"+sendSql);
        LOGGER.severe("receiveSql:"+receiveSql);
        /<strong><em> 
         * 查询当前用户在该项目中的专业（ME,EL等)，拼接QueryText
         * dDocType <matches> <code>PJT-INTERFACE-DOC</code>
         * </em></strong></em>**/
        UCMAdapter ap=new UCMAdapter();
        this.sendDocumentList = (ArrayList<Document>)ap.search(userId.toString(), sendSql);
        this.receiveDocumentList = (ArrayList<Document>)ap.search(userId.toString(), receiveSql);
        LOGGER.severe("success init...YES.");
        return "YES";
    }</p>
<div class="highlight"><pre><span></span>public void setReceiveDocumentList(ArrayList&lt;Document&gt; receiveDocumentList) {
    this.receiveDocumentList = receiveDocumentList;
}

public ArrayList&lt;Document&gt; getReceiveDocumentList() {
    return receiveDocumentList;
}

public void setSendDocumentList(ArrayList&lt;Document&gt; sendDocumentList) {
    this.sendDocumentList = sendDocumentList;
}

public ArrayList&lt;Document&gt; getSendDocumentList() {
    return sendDocumentList;
}
</pre></div>


<p _="%" endcodeblock="endcodeblock">}</p>
        </div><!-- /.entry-content -->
</div>
        </div>
        <div class="span3 offset1">
          <div class="well">
            <ul class="nav nav-list">
              <li class="nav-header">Blog</li>
              <li ><a href="http://pelican.dengdezhao.cn">Index</a></li>
              <li ><a href="http://pelican.dengdezhao.cn/tags/">Tags</a></li>
              <li ><a href="http://pelican.dengdezhao.cn/archives/">Archiv</a></li>
            </ul>
          </div><!-- /#menu -->
        </div>
      </div>

      <hr />

      <div class="row">
        <div class="span12">
          <div id="about">
            <p>Proudly powered by <a href="http://twitter.github.com/bootstrap/">bootstrap</a>, <a href="http://docs.notmyidea.org/alexis/pelican/">pelican</a>, <a href="http://python.org">python</a> and <a href="http://www.julo.ch/about/">Alex</a>!</p>
          </div><!-- /#about -->
        </div><!-- /#contentinfo -->
      </div>
    </div>


  </body>
</html>